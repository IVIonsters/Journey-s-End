// establishes navlinks for eventlisteners to set city to local storage
const tampaLink = document.getElementById('tampa');
const atlantaaLink = document.getElementById('atlanta');
const philiLink = document.getElementById('philadelphia')
const miamiLink = document.getElementById('miami')
const pittLink = document.getElementById('pittsburgh')

// sets city when user clicks a city in the nav link
tampaLink.addEventListener('click', function() {localStorage.setItem('city', JSON.stringify('tampa'));});
atlantaaLink.addEventListener('click', function() {localStorage.setItem('city', JSON.stringify('atlanta'));});
philiLink.addEventListener('click', function () {localStorage.setItem('city', JSON.stringify('philadelphia'));});
miamiLink.addEventListener('click', function () {localStorage.setItem('city', JSON.stringify('miami'));});
pittLink.addEventListener('click', function () {localStorage.setItem('city', JSON.stringify('pittsburgh'));});

// function to hit ticketmaster API and pull data for card generation
const getSuggestions = function () {

    let cityData = localStorage.getItem('city');
    let city = JSON.parse(cityData);
  
    const requestOptions = {
      method: "GET",
      redirect: "follow"
    };
  
    fetch(`https://app.ticketmaster.com/discovery/v2/events.json?&city=${city}&apikey=PX9R1m9GGLoYMZnyzl7zDQT2EZJyjBqX`, requestOptions)
      .then(response => response.json())
      .then(response => localStorage.setItem('erosEvents', JSON.stringify(response)))
      .catch(err => console.error(err));
  
    fetch(`https://app.ticketmaster.com/discovery/v2/attractions.json?&keyword=${city}&apikey=PX9R1m9GGLoYMZnyzl7zDQT2EZJyjBqX`, requestOptions)
      .then(response => response.json())
      .then(response => localStorage.setItem('erosAttractions', JSON.stringify(response)))
      .catch(err => console.error(err));
  
    fetch(`https://app.ticketmaster.com/discovery/v2/suggest.json?&keyword=${city}&apikey=PX9R1m9GGLoYMZnyzl7zDQT2EZJyjBqX`, requestOptions)
      .then(response => response.json())
      .then(response => localStorage.setItem('erosSuggest', JSON.stringify(response)))
      .catch(err => console.error(err));
  
    setTimeout(() => {
      prepareResults();
    }, 750); // 750 milliseconds to prevent issues when executing prepare results
  };
  
  
  // prepare resutls function parses local storage items generated by getSuggestions and pushes the data to an array called erosFinds 
  const prepareResults = function () {
  
    // erosEvents
    const erosEvents = JSON.parse(localStorage.getItem('erosEvents'));
    const erosFinds = [];
    erosEvents._embedded.events.forEach(event => {
        const name = event.name;
        const imageUrl = event.images[0].url; 
        const ticketingUrl = event.url;
    
        erosFinds.push({ name, imageUrl, ticketingUrl });
    });
  
    // erosAttractions
    const erosAttractions = JSON.parse(localStorage.getItem('erosAttractions'));
    erosAttractions._embedded.attractions.forEach(attraction => {
  
      const name = attraction.name;
      const imageUrl = attraction.images[0].url;
      const ticketingUrl = attraction.url; 
  
      erosFinds.push({ name, imageUrl, ticketingUrl});
    })
  
    // erosSuggest
    const erosSuggest = JSON.parse(localStorage.getItem('erosSuggest'));
    erosSuggest._embedded.attractions.forEach(suggest => {
  
      const name = suggest.name;
      const imageUrl = suggest.images[0].url;
      const ticketingUrl = suggest.url; 
  
      erosFinds.push({ name, imageUrl, ticketingUrl});
  
    })
  
    // Save the updated erosFinds array back to localStorage
    localStorage.setItem('erosFinds', JSON.stringify(erosFinds));
    randomizeErosFinds();
    generateResults();
  
  };
  
  // randomize results and select only 3 to populate erosPicks
  const randomizeErosFinds = function () {
  
    // Retrieve the array from local storage
    const erosFindsArray = JSON.parse(localStorage.getItem('erosFinds'));
  
    // Create a new array to store randomly selected items
    const erosPicks = [];
  
    // Randomly select 3 items from the original array
    while (erosPicks.length < 3) {
      const randomIndex = Math.floor(Math.random() * erosFindsArray.length);
      const selectedItem = erosFindsArray[randomIndex];
  
      if (!erosPicks.includes(selectedItem)) {
        erosPicks.push(selectedItem);
      }
    }
  
    // Store the new array back into local storage
    localStorage.setItem('erosPicks', JSON.stringify(erosPicks));
  
  };
  
  // function to render results in the viewport
  const generateResults = function () {
    // Retrieve the array from localStorage
    const erosFindsArray = JSON.parse(localStorage.getItem('erosPicks')) || [];
    const container = document.querySelector('.container-lg .row');
  
    // Function to generate the HTML for each event
    const generateEventHtml = (event) => {
        return `
            <div class="col m-3 p-3 rounded text-center cards">
                <h1 class="text-decoration-underline event">${event.title}</h1>
                <img src="${event.imageSrc}" height="200px" width="300px" class="card m-3">
                <p><a href="${event.url}" class="link">Get Tickets!</a></p>
            </div>
        `;
    };
  
    // Function to clear the existing content in the container
    const clearResults = () => {
        container.innerHTML = '' ;
    };
  
    // Function to generate new results
    const generateNewResults = () => {
        clearResults();
        erosFindsArray.forEach((item) => {
            const eventData = [
                {
                    title: item.name,
                    imageSrc: item.imageUrl,
                    url: item.ticketingUrl
                }
            ];
  
            eventData.forEach((event) => {
                const eventHtml = generateEventHtml(event);
                container.insertAdjacentHTML('beforeend', eventHtml);
            });
        });
    };
  
    // Initial generation of results
    generateNewResults();
  
    // Add an event listener to the "Try Again" button
    const tryAgainButton = document.getElementById('tryAgain');
    tryAgainButton.addEventListener('click', function() {
        prepareResults();
        generateNewResults();
    });
  };
  
  
  // fire off getSuggestions
  getSuggestions();
  